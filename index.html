<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI NEWS – Die aktuellsten Nachrichten</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--red:#e50914}
  *{box-sizing:border-box}
  body{font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#fff;color:#111}
  /* Header */
  header{background:var(--red);color:#fff;padding:14px 22px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;text-transform:uppercase;font-size:24px;letter-spacing:.5px}
  header em{font-style:italic}
  header a.brand{color:#fff;text-decoration:none;display:inline-flex;align-items:center}
  header a.brand:focus, header a.brand:hover{opacity:.9}
  /* Nav */
  nav{display:flex;gap:10px;overflow:auto;padding:10px 16px;border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:5}
  .tab{padding:8px 12px;border:none;background:#fff;border-bottom:3px solid transparent;font-weight:700;color:#555;text-decoration:none;white-space:nowrap}
  .tab.active{color:var(--red);border-color:var(--red)}
  .personalize{margin-left:auto;color:#e50914;background:transparent;border:1px solid #e50914;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:700}
  .personalize:hover{background:#ffecee}
  /* Layout */
  main{max-width:1220px;margin:18px auto;padding:0 16px}
  #loading{padding:20px;color:#666}
  /* Hero (ohne Bild) */
  .hero{display:block;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08);text-decoration:none;color:inherit;margin-bottom:16px;background:#111}
  .hero .inner{padding:18px;color:#fff}
  .hero h2{margin:6px 0 0;font-size:26px}
  .hero p{margin:8px 0 0;color:#f3f3f3}
  .meta{font-size:12px;color:#bbb}
  /* Grid (Text-Karten) */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  .card{display:block;background:#fff;border-radius:12px;overflow:hidden;text-decoration:none;color:inherit;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .card .inner{padding:12px}
  .card h3{margin:4px 0 0;font-size:16px;line-height:1.25}
  .card p{margin:8px 0 0;color:#444;font-size:14px}
  /* Article page */
  .article{max-width:860px;margin:18px auto;padding:0 16px}
  .article h1{font-size:24px;margin:8px 0}
  .article .meta{margin:6px 0 12px;color:#666}
  .article .sources{margin-top:18px;padding:12px;background:#f7f7f7;border-radius:8px}
  .article .sources a{color:#e50914}
  .back{display:inline-block;margin:12px 16px;color:#e50914;text-decoration:none;font-weight:700;cursor:pointer}
  footer{padding:18px;text-align:center;color:#666}
  /* Modal Personalisieren */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;border-radius:12px;max-width:560px;width:92%;box-shadow:0 25px 80px rgba(0,0,0,.25);overflow:hidden}
  .modal header{background:#f8f8f8;color:#111;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
  .modal header h3{margin:0;font-size:18px}
  .modal .content{padding:14px 16px;max-height:60vh;overflow:auto}
  .modal .cats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .modal .cat{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #eee;border-radius:10px}
  .modal footer{padding:12px 16px;display:flex;gap:8px;border-top:1px solid #eee;background:#fafafa}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:#e50914;color:#fff;border-color:#e50914}
  .btn.ghost{background:transparent;border-color:transparent;color:#555}
  .note{font-size:12px;color:#666;margin-top:6px}
  /* Badge */
  #modeBadge{position:fixed;right:10px;bottom:10px;padding:6px 10px;border-radius:999px;font-size:12px;background:#eee;color:#333}
</style>
</head>
<body>

<header>
  <h1><a class="brand" id="brandLink" href="#/">AI <em>NEWS</em></a></h1>
</header>

<nav id="nav"></nav>

<main id="app">
  <div id="loading">Lade…</div>
</main>

<footer>© AI NEWS</footer>
<div id="modeBadge" title="Anzeigemodus">—</div>

<!-- Personalisieren Modal -->
<div id="personalizeBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="persoTitle">
    <header>
      <h3 id="persoTitle">Kategorien personalisieren</h3>
      <button id="btnCloseModal" class="btn ghost" aria-label="Schließen">✕</button>
    </header>
    <div class="content">
      <p>Wähle aus, welche Kategorien in der Leiste angezeigt werden sollen.</p>
      <div id="catsList" class="cats"></div>
      <p class="note">Hinweis: Mindestens eine Kategorie muss aktiviert bleiben.</p>
    </div>
    <footer>
      <button id="btnSelectAll" class="btn">Alle auswählen</button>
      <button id="btnSelectDefault" class="btn">Standard</button>
      <button id="btnReset" class="btn">Zurücksetzen</button>
      <div style="flex:1"></div>
      <button id="btnCancel" class="btn">Abbrechen</button>
      <button id="btnSave" class="btn primary">Speichern</button>
    </footer>
  </div>
</div>

<script>
/* ========= Einstellungen ========= */
const CACHE_TTL_MS = 2 * 60 * 1000;
const INITIAL_RENDER = 12;
const LOAD_STEP = 12;

/* ========= Kategorien & Routing ========= */
const ALL_CATS = [
  {slug:"",           label:"Nachrichten",  cat:"Top"},
  {slug:"politik",    label:"Politik",      cat:"Politik"},
  {slug:"finanzen",   label:"Finanzen",     cat:"Finanzen"},
  {slug:"sport",      label:"Sport",        cat:"Sport"},
  {slug:"fussball",   label:"Fußball",      cat:"Fußball"},
  {slug:"kultur",     label:"Kultur",       cat:"Kultur"},
  {slug:"entertainment", label:"Entertainment", cat:"Entertainment"},
  {slug:"wissenschaft",  label:"Wissenschaft",  cat:"Wissenschaft"}
];
const SLUG_TO_CAT = Object.fromEntries(ALL_CATS.map(c=>[c.slug||"", c.cat]));
const CAT_TO_SLUG = Object.fromEntries(ALL_CATS.map(c=>[c.cat, c.slug||""]));
const DEFAULT_VISIBLE = ALL_CATS.map(c=>c.slug||"");

const LS_VISIBLE_KEY = "AIN_visible_slugs_v2";
const LS_LAST_SLUG   = "AIN_last_slug_v2";

function loadVisibleSlugs(){
  try{
    const raw = localStorage.getItem(LS_VISIBLE_KEY);
    const arr = raw ? JSON.parse(raw) : null;
    if (Array.isArray(arr) && arr.length) return arr;
  }catch{}
  return [...DEFAULT_VISIBLE];
}
function saveVisibleSlugs(slugs){ localStorage.setItem(LS_VISIBLE_KEY, JSON.stringify(slugs)); }
function getVisibleCats(){ const vis=loadVisibleSlugs(); return ALL_CATS.filter(c=>vis.includes(c.slug||"")); }

let LAST_SLUG = localStorage.getItem(LS_LAST_SLUG) || "";

/* ========= Nav ========= */
const navEl = document.getElementById('nav');
function renderNav(activeSlug){
  navEl.innerHTML = "";
  const visible = getVisibleCats();
  const slugsOnly = visible.map(v=>v.slug||"");
  if (activeSlug != null && slugsOnly.length){
    const ok = slugsOnly.includes(activeSlug);
    if (!ok){
      const target = slugsOnly[0];
      location.hash = target ? `#/${target}` : "#/";
      activeSlug = target;
    }
  }
  visible.forEach(v=>{
    const href = v.slug ? `#/${v.slug}` : "#/";
    const a = document.createElement('a');
    a.className = "tab";
    a.href = href;
    a.textContent = v.label;
    const isRoot = href==="#/";
    const match = isRoot ? (!activeSlug || activeSlug==="/" || activeSlug==="") : (v.slug===activeSlug);
    if (match) a.classList.add('active');
    navEl.appendChild(a);
  });
  const btn = document.createElement('button');
  btn.id = "btnPersonalize";
  btn.className = "personalize";
  btn.type = "button";
  btn.textContent = "+ Personalisieren";
  btn.style.marginLeft = "auto";
  btn.addEventListener('click', openPersonalize);
  navEl.appendChild(btn);
}
function setActiveTab(slug){ renderNav(slug); }

/* ========= Backend/Client-Mode ========= */
const STORE={byId:{},mode:"auto"};
const badge=document.getElementById('modeBadge');

async function fetchWithTimeout(url,opts={},ms=10000){
  return Promise.race([fetch(url,opts),new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),ms))]);
}
async function tryServerArticles(category){
  try{
    const r=await fetchWithTimeout(`/api/articles?category=${encodeURIComponent(category)}`,{},12000);
    if(!r.ok) throw new Error("server "+r.status);
    const js=await r.json();
    if(js&&js.ok&&Array.isArray(js.articles)&&js.articles.length){
      js.articles = js.articles.map(a=>({ ...a, firstPub: a.firstPub || a.pub, cat: a.cat || category }));
      STORE.mode="server"; badge.textContent="Server-Modus"; 
      return js.articles;
    }
    throw new Error("no articles");
  }catch(e){ return null; }
}
async function tryServerArticle(id){
  try{
    const r=await fetchWithTimeout(`/api/article/${encodeURIComponent(id)}`,{},12000);
    if(!r.ok) throw new Error("server "+r.status);
    const js=await r.json();
    if(js&&js.ok&&js.article){
      js.article.firstPub = js.article.firstPub || js.article.pub;
      STORE.mode="server"; badge.textContent="Server-Modus";
      return js.article;
    }
    throw new Error("not found");
  }catch(e){ return null; }
}

/* ========= Client-RSS Feeds ========= */
const FEEDS={
  Top:[
    "https://feeds.bbci.co.uk/news/rss.xml",
    "https://feeds.reuters.com/reuters/topNews",
    "https://rss.cnn.com/rss/edition.rss",
    "https://www.cbsnews.com/latest/rss/main",
    "https://www.nbcnews.com/rss",
    "https://feeds.foxnews.com/foxnews/latest",
    "https://rssfeeds.usatoday.com/usatoday-NewsTopStories",
    "https://abcnews.go.com/abcnews/topstories"
  ],
  Politik:[
    "https://feeds.bbci.co.uk/news/politics/rss.xml",
    "https://rss.cnn.com/rss/edition_world.rss",
    "https://www.theguardian.com/world/rss",
    "https://feeds.skynews.com/feeds/rss/politics.xml",
    "https://www.nbcnews.com/politics/politics-news/rss"
  ],
  Finanzen:[
    "https://feeds.bbci.co.uk/news/business/rss.xml",
    "https://www.reuters.com/business/finance/rss.xml",
    "https://www.cnbc.com/id/10001147/device/rss/rss.html",
    "https://www.foxbusiness.com/feeds/rss"
  ],
  /* SPORT – inkl. europäischer Quellen */
  Sport:[
    /* UK / International */
    "https://feeds.bbci.co.uk/sport/rss.xml?edition=uk",
    "https://rss.cnn.com/rss/edition_sport.rss",
    "https://www.espn.com/espn/rss/news",
    "https://www.espn.com/espn/rss/soccer/news",
    "https://feeds.reuters.com/reuters/sportsNews",
    "https://www.theguardian.com/sport/rss",
    "https://www.skysports.com/rss/12040",
    "https://www.cbssports.com/rss/headlines/",
    "https://www.eurosport.com/rss.xml",
    /* Deutschland */
    "https://rss.kicker.de/news/fussball",
    "https://www.spiegel.de/sport/index.rss",
    "https://www.faz.net/rss/aktuell/sport/",
    /* Spanien */
    "https://e00-marca.uecdn.es/rss/futbol.xml",
    "https://as.com/rss/futbol/",
    "https://www.mundodeportivo.com/rss/futbol",
    /* Italien */
    "https://www.gazzetta.it/rss/Calcio.xml",
    "https://www.corrieredellosport.it/rss/calcio.xml",
    "https://www.tuttosport.com/rss/calcio.xml",
    /* Frankreich */
    "https://www.lequipe.fr/rss/actu_rss.xml",
    "https://rmcsport.bfmtv.com/rss/",
    /* Niederlande */
    "https://feeds.nos.nl/nossport",
    "https://www.vi.nl/rss"
  ],
  /* Fußball – reine Fußballfeeds, EU-lastig */
  Fußball:[
    /* UK */
    "https://www.skysports.com/rss/12040",
    "https://www.theguardian.com/football/rss",
    "https://feeds.bbci.co.uk/sport/football/rss.xml",
    "https://www.independent.co.uk/sport/football/rss",
    /* DE */
    "https://rss.kicker.de/news/fussball",
    "https://www.spiegel.de/sport/index.rss",
    /* ES */
    "https://e00-marca.uecdn.es/rss/futbol.xml",
    "https://as.com/rss/futbol/",
    "https://www.mundodeportivo.com/rss/futbol",
    /* IT */
    "https://www.gazzetta.it/rss/Calcio.xml",
    "https://www.corrieredellosport.it/rss/calcio.xml",
    "https://www.tuttosport.com/rss/calcio.xml",
    /* FR */
    "https://www.lequipe.fr/rss/actu_rss.xml",
    "https://rmcsport.bfmtv.com/rss/",
    /* NL */
    "https://www.vi.nl/rss"
  ],
  Kultur:[
    "https://feeds.bbci.co.uk/news/entertainment_and_arts/rss.xml",
    "https://www.theguardian.com/culture/rss"
  ],
  Entertainment:[
    "https://rss.cnn.com/rss/edition_entertainment.rss",
    "https://www.usatoday.com/entertainment/rss/"
  ],
  Wissenschaft:[
    "https://rss.nytimes.com/services/xml/rss/nyt/Science.xml",
    "https://www.nature.com/subjects/rss.xml",
    "https://www.sciencedaily.com/rss/top/science.xml"
  ]
};

/* ========= RSS-Fetch & Parsing ========= */
async function fetchFeed(url){
  try{
    const res=await fetchWithTimeout(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&disableCache=true`,{},15000);
    if(res.ok){ const j=await res.json(); if(j&&j.contents && j.contents.length>100) return j.contents; }
  }catch(e){}
  try{
    const r2=await fetchWithTimeout(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`,{},15000);
    const j2=await r2.json();
    if(j2&&Array.isArray(j2.items)&&j2.items.length){
      return j2.items.map(it=>(
        `<item><title>${it.title||""}</title><link>${it.link||""}</link><description>${(it.description||"").replace(/<!\$begin:math:display$CDATA\\\\\[\|\\$end:math:display$\\]>/g,"")}</description><pubDate>${it.pubDate||""}</pubDate></item>`
      )).join("");
    }
  }catch(e){}
  return "";
}
function parseFeed(xml,fallbackHost=""){
  const p=new DOMParser(); const doc=p.parseFromString(xml,"text/xml"); const items=[...doc.querySelectorAll("item")];
  return items.map(it=>{
    const title=it.querySelector("title")?.textContent?.trim()||"";
    const link =it.querySelector("link")?.textContent?.trim()||"";
    const descRaw=it.querySelector("description")?.textContent||"";
    const desc=descRaw.replace(/<!\\[CDATA\\[|\\]\\]>/g,"").replace(/<[^>]+>/g," ").replace(/\s{2,}/g," ").trim();
    const pub =it.querySelector("pubDate")?.textContent||"";
    let host=""; try{ host=new URL(link).hostname.replace(/^www\\./,''); }catch{ host=fallbackHost; }
    return {title,link,desc,pub,host};
  }).filter(x=>x.title&&x.link);
}

/* ========= Clustering ========= */
function cleanTitle(s){
  s = (s||"")
    .replace(/\s*[-–|]\s*(reuters|bbc|cnn|the guardian|sky news|cnbc|fox|nbc|abc|cbs|usatoday)\b.*$/i,"")
    .replace(/\[[^\]]+\]|\([^)]*\)|\"|\'/g," ")
    .replace(/\s+/g," ")
    .trim();
  return s;
}
function normTitle(s){
  s = cleanTitle(s);
  s = s.toLowerCase().replace(/[^a-z0-9äöüß ]/gi," ").replace(/\s+/g," ").trim();
  return s;
}
function jaccard(a,b){
  const A=new Set(normTitle(a).split(" ").filter(Boolean));
  const B=new Set(normTitle(b).split(" ").filter(Boolean));
  const inter=[...A].filter(x=>B.has(x)).length;
  const uni=new Set([...A,...B]).size||1;
  return inter/uni;
}
function groupSimilar(items,th=0.45){
  const groups=[];
  for(const it of items){
    let placed=false;
    for(const g of groups){
      if(jaccard(it.title, g[0].title) >= th){ g.push(it); placed=true; break; }
    }
    if(!placed) groups.push([it]);
  }
  return groups;
}

/* ---- Konsens-Objekte ---- */
function buildConsensus(groups,cat){
  const result=[];
  for(const g of groups){
    const seen=new Set(), picked=[];
    for(const it of g){
      if(!seen.has(it.host)){ picked.push(it); seen.add(it.host); }
      if(picked.length>=4) break; // max 4 Quellen/Konsens
    }
    const title = picked.slice().sort((a,b)=>b.title.length-a.title.length)[0]?.title || picked[0]?.title || "Artikel";
    const sentences=[];
    picked.forEach(p=>{
      (p.desc||"").split(/(?<=[.!?])\s+/).forEach(s=>{
        const t=s.trim(); if(t && !sentences.some(x=>jaccard(x,t)>0.8)) sentences.push(t);
      });
    });
    const dek = sentences.join(" ").slice(0,750);

    const ts = picked.map(p=>Date.parse(p.pub)).filter(t=>!Number.isNaN(t));
    const newest = ts.length ? new Date(Math.max(...ts)) : new Date();
    const oldest = ts.length ? new Date(Math.min(...ts)) : newest;

    const pub = newest.toISOString();       // Sortierung
    const firstPub = oldest.toISOString();  // Anzeige
    const sources = picked.map(p=>({ source:p.host, title:p.title, url:p.link }));
    const sourceCount = sources.length;

    result.push({ id:Math.random().toString(36).slice(2), title, dek, pub, firstPub, sources, sourceCount, cat });
  }
  result.sort((a,b)=>Date.parse(b.pub)-Date.parse(a.pub));
  return result;
}

async function clientFetchCategory(cat){
  const urls=FEEDS[cat]||FEEDS.Top;
  const all=[];
  for(const u of urls){
    const host=(()=>{ try{ return new URL(u).hostname.replace(/^www\\./,''); }catch{ return ""; }})();
    const xml=await fetchFeed(u);
    if(!xml) continue;
    const items=parseFeed(xml,host);
    all.push(...items);
  }
  if(!all.length) return [];
  let groups = groupSimilar(all, 0.45);
  const singles = groups.filter(g=>g.length===1).length;
  if (singles/groups.length > 0.7) groups = groupSimilar(all, 0.40);
  return buildConsensus(groups, cat);
}

/* ========= Cache ========= */
function cacheKey(cat){ return `AIN_cache_${cat}_noimg_firstPub_v2`; }
function getCached(cat){
  try{ const raw=sessionStorage.getItem(cacheKey(cat)); if(!raw) return null;
    const obj=JSON.parse(raw); if(Date.now()-obj.ts > CACHE_TTL_MS) return null; return obj.data||null;
  }catch{ return null; }
}
function setCached(cat,data){ try{ sessionStorage.setItem(cacheKey(cat), JSON.stringify({ts:Date.now(),data})); }catch{} }

/* ========= Formatierung ========= */
function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  try{
    return new Intl.DateTimeFormat('de-DE',{
      weekday:'short', day:'2-digit', month:'2-digit', year:'numeric',
      hour:'2-digit', minute:'2-digit'
    }).format(d);
  }catch{ return d.toLocaleString('de-DE'); }
}
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function trunc(s,n){ s=s||''; return s.length>n ? s.slice(0,n-1)+'…' : s; }

/* ========= Daten holen ========= */
async function getArticles(cat){
  const cached=getCached(cat); if(cached&&cached.length) return cached;
  let arts=await tryServerArticles(cat);
  if(arts&&arts.length){ setCached(cat, arts); return arts; }
  const list=await clientFetchCategory(cat); setCached(cat,list); return list;
}

/* ========= Rendering ========= */
let renderCount=INITIAL_RENDER;

async function renderCategory(cat,slug){
  LAST_SLUG=slug||""; localStorage.setItem(LS_LAST_SLUG, LAST_SLUG);
  setActiveTab(LAST_SLUG);
  const app=document.getElementById('app');
  app.innerHTML=`<div id="loading">Lade Artikel…</div>`;
  badge.textContent="Modus ermitteln…";

  const arts = (await getArticles(cat)).slice().sort((a,b)=>Date.parse(b.pub)-Date.parse(a.pub));
  if(!arts||!arts.length){ app.innerHTML=`<p style="padding:16px;color:#666">Keine Artikel gefunden.</p>`; return; }
  STORE.byId=Object.fromEntries(arts.map(a=>[a.id,a]));
  badge.textContent=STORE.mode==="server"?"Server-Modus":"Client-Modus";

  renderCount=INITIAL_RENDER;

  const top=arts[0];
  const hero=`
    <a class="hero" href="#/artikel/${top.id}">
      <div class="inner">
        <div class="meta">${fmtDate(top.firstPub || top.pub)} • Aggregiert aus ${top.sourceCount|| (top.sources?.length||1)} Quelle${(top.sourceCount|| (top.sources?.length||1))>1?'n':''}</div>
        <h2>${escapeHtml(top.title)}</h2>
        <p>${escapeHtml(trunc(top.dek,220))}</p>
      </div>
    </a>`;

  const makeCard=(a)=>`
    <a class="card" href="#/artikel/${a.id}">
      <div class="inner">
        <div class="meta">${fmtDate(a.firstPub || a.pub)} • Aggregiert aus ${a.sourceCount|| (a.sources?.length||1)} Quelle${(a.sourceCount|| (a.sources?.length||1))>1?'n':''}</div>
        <h3>${escapeHtml(a.title)}</h3>
        <p>${escapeHtml(trunc(a.dek,180))}</p>
      </div>
    </a>`;

  const rest=arts.slice(1);
  const firstChunk=rest.slice(0,renderCount-1).map(makeCard).join('');
  const moreLeft=rest.length-(renderCount-1);

  app.innerHTML = `${hero}<div id="grid" class="grid">${firstChunk}</div>${moreLeft>0?`<button id="loadmore" class="btn">Mehr laden (${moreLeft})</button>`:''}`;

  const btn=document.getElementById('loadmore');
  if(btn){
    btn.addEventListener('click',()=>{
      const grid=document.getElementById('grid');
      const next=rest.slice(renderCount-1,renderCount-1+LOAD_STEP).map(makeCard).join('');
      grid.insertAdjacentHTML('beforeend',next);
      renderCount+=LOAD_STEP;
      const remaining=rest.length-(renderCount-1);
      if(remaining>0) btn.textContent=`Mehr laden (${remaining})`; else btn.remove();
    });
  }
}

function attachBackHandler(){
  const link = document.getElementById('backLink');
  if(!link) return;
  link.addEventListener('click', handleBack);
}
function handleBack(e){
  e.preventDefault();
  const fallback = LAST_SLUG ? `#/${LAST_SLUG}` : "#/";
  const before = location.hash;
  let navigated = false;
  const onHash = ()=>{ navigated = true; window.removeEventListener('hashchange', onHash); };
  window.addEventListener('hashchange', onHash, {once:true});

  if (history.length > 1) history.back();
  // Fallback, wenn es keinen Verlauf gibt (z.B. direkter Einstieg ins Artikel-Deep-Link)
  setTimeout(()=>{ if(!navigated || location.hash === before){ location.hash = fallback; } }, 200);
}

async function renderArticle(id){
  setActiveTab(LAST_SLUG);
  const app=document.getElementById('app');
  app.innerHTML=`<div id="loading">Lade Artikel…</div>`;

  const srv=await tryServerArticle(id);
  if(srv){
    const cat=srv.cat||'Top';
    const slugFromCat=CAT_TO_SLUG[cat]||LAST_SLUG||"";
    LAST_SLUG=slugFromCat; localStorage.setItem(LS_LAST_SLUG, LAST_SLUG); setActiveTab(LAST_SLUG);
    const sources=(srv.sources||[]).map(s=>`
      <li>${escapeHtml(s.source)}: <a href="${s.url}" target="_blank" rel="noopener">${escapeHtml(s.title)}</a></li>
    `).join('');
    const count = srv.sourceCount || (srv.sources?.length||1);
    app.innerHTML=`
      <a class="back" id="backLink" href="#/">← Zurück</a>
      <section class="article">
        <div class="meta">Veröffentlicht: ${fmtDate(srv.firstPub || srv.pub)} • Aggregiert aus ${count} Quelle${count>1?'n':''}</div>
        <h1>${escapeHtml(srv.title)}</h1>
        <p>${escapeHtml(srv.dek || "")}</p>
        ${srv.body||''}
        <div class="sources">
          <h3>Quellen</h3>
          <ul>${sources}</ul>
        </div>
      </section>`;
    attachBackHandler();
    badge.textContent="Server-Modus";
    return;
  }

  const a=STORE.byId[id];
  const cat=a?.cat||'Top';
  const slugFromCat=CAT_TO_SLUG[cat]||LAST_SLUG||"";
  LAST_SLUG=slugFromCat; localStorage.setItem(LS_LAST_SLUG, LAST_SLUG); setActiveTab(LAST_SLUG);

  if(!a){ app.innerHTML=`<p style="padding:16px;color:#666">Artikel nicht gefunden.</p>`; badge.textContent="Client-Modus"; return; }
  const sources=(a.sources||[]).map(s=>`
    <li>${escapeHtml(s.source)}: <a href="${s.url}" target="_blank" rel="noopener">${escapeHtml(s.title)}</a></li>
  `).join('');
  const count = a.sourceCount || (a.sources?.length||1);
  app.innerHTML=`
    <a class="back" id="backLink" href="#/">← Zurück</a>
    <section class="article">
      <div class="meta">Veröffentlicht: ${fmtDate(a.firstPub || a.pub)} • Aggregiert aus ${count} Quelle${count>1?'n':''}</div>
      <h1>${escapeHtml(a.title)}</h1>
      <p>${escapeHtml(a.dek || "")}</p>
      <div class="sources">
        <h3>Quellen</h3>
        <ul>${sources}</ul>
      </div>
    </section>`;
  attachBackHandler();
  badge.textContent="Client-Modus";
}

/* ========= Router ========= */
function getRoute(){
  const hash=(location.hash||"#/").replace(/^#/,"");
  const parts=hash.split("/").filter(Boolean);
  if(!parts.length) return {name:"category",cat:"Top",slug:""};
  if(parts[0]==="artikel") return {name:"article",id:parts[1]||""};
  const slug=parts[0];
  return {name:"category",cat:SLUG_TO_CAT[slug]||"Top",slug};
}
async function route(){
  const r=getRoute();
  if (navEl.childElementCount===0) renderNav(r.name==="article" ? LAST_SLUG : (r.slug||""));
  if(r.name==="article") return renderArticle(r.id);
  return renderCategory(r.cat,r.slug);
}
window.addEventListener('hashchange',route);
renderNav(LAST_SLUG);
route();

/* ========= Personalisieren Modal ========= */
const backdrop = document.getElementById('personalizeBackdrop');
const catsList = document.getElementById('catsList');
const btnCloseModal = document.getElementById('btnCloseModal');
const btnCancel = document.getElementById('btnCancel');
const btnSave = document.getElementById('btnSave');
const btnSelectAll = document.getElementById('btnSelectAll');
const btnSelectDefault = document.getElementById('btnSelectDefault');
const btnReset = document.getElementById('btnReset');

function openPersonalize(){
  catsList.innerHTML = "";
  const selected = new Set(loadVisibleSlugs());
  ALL_CATS.forEach(c=>{
    const id = `ck_${c.slug||'root'}`;
    const wrap = document.createElement('label');
    wrap.className = "cat";
    wrap.innerHTML = `
      <input type="checkbox" id="${id}" ${selected.has(c.slug||"")?'checked':''} data-slug="${c.slug}">
      <span>${c.label}</span>
    `;
    catsList.appendChild(wrap);
  });
  backdrop.style.display = "flex";
  backdrop.setAttribute('aria-hidden','false');
}
function closePersonalize(){
  backdrop.style.display = "none";
  backdrop.setAttribute('aria-hidden','true');
}
function getModalSelection(){
  const boxes = catsList.querySelectorAll('input[type=checkbox]');
  const sel = [];
  boxes.forEach(b=>{ if(b.checked) sel.push(b.getAttribute('data-slug')||""); });
  return sel;
}
btnCloseModal.addEventListener('click', closePersonalize);
btnCancel.addEventListener('click', closePersonalize);
backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closePersonalize(); });

btnSelectAll.addEventListener('click', ()=>{
  catsList.querySelectorAll('input[type=checkbox]').forEach(b=>b.checked=true);
});
btnSelectDefault.addEventListener('click', ()=>{
  const def = new Set(DEFAULT_VISIBLE);
  catsList.querySelectorAll('input[type=checkbox]').forEach(b=>{
    const slug = b.getAttribute('data-slug')||"";
    b.checked = def.has(slug);
  });
});
btnReset.addEventListener('click', ()=>{
  localStorage.removeItem(LS_VISIBLE_KEY);
  const def = new Set(DEFAULT_VISIBLE);
  catsList.querySelectorAll('input[type=checkbox]').forEach(b=>{
    const slug = b.getAttribute('data-slug')||"";
    b.checked = def.has(slug);
  });
});
btnSave.addEventListener('click', ()=>{
  const sel = getModalSelection();
  if (!sel.length){
    alert("Mindestens eine Kategorie muss aktiviert bleiben.");
    return;
  }
  saveVisibleSlugs(sel);
  const current = getRoute();
  const activeSlug = current.name==="article" ? LAST_SLUG : (current.slug||"");
  renderNav(activeSlug);
  if (!sel.includes(activeSlug)){
    const target = sel[0] || "";
    location.hash = target ? `#/${target}` : "#/";
  }
  closePersonalize();
});
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape' && backdrop.style.display === 'flex') closePersonalize();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI NEWS – Die aktuellsten Nachrichten</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--red:#e50914}
  *{box-sizing:border-box}
  body{font-family:Outfit,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#fff;color:#111}

  /* Header */
  header{background:var(--red);color:#fff;padding:14px 22px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;text-transform:uppercase;font-size:24px;letter-spacing:.5px}
  header em{font-style:italic}
  header a.brand{color:#fff;text-decoration:none;display:inline-flex;align-items:center}
  header a.brand:focus, header a.brand:hover{opacity:.9}

  /* Nav mit Suchleiste */
  nav{
    display:flex;align-items:center;gap:10px;
    overflow:hidden;padding:10px 16px;border-bottom:1px solid #eee;background:#fff;
    position:sticky;top:0;z-index:5
  }
  .tabs-wrap{display:flex;gap:10px;overflow:auto;flex:1}
  .tab{padding:8px 12px;border:none;background:#fff;border-bottom:3px solid transparent;font-weight:700;color:#555;text-decoration:none;white-space:nowrap}
  .tab.active{color:var(--red);border-color:var(--red)}
  .nav-search{
    min-width:180px;max-width:240px;width:22ch;
    padding:8px 10px 8px 30px;border:1px solid #ddd;border-radius:999px;
    background:#fafafa url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23999" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85h-.017zm-5.242 1.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>') no-repeat 10px 50%;
    background-size:16px 16px;color:#666;outline:none;
  }
  .nav-search:disabled{opacity:1;color:#999;cursor:not-allowed}
  .personalize{color:#e50914;background:transparent;border:1px solid #e50914;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:700}
  .personalize:hover{background:#ffecee}

  /* Layout */
  main{max-width:1220px;margin:18px auto;padding:0 16px}
  #loading{padding:20px;color:#666}

  /* Media */
  .media{position:relative;overflow:hidden;background:#f2f2f2}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .hero .media{height:200px}
  .card .media{height:120px}
  .article .media{height:260px;border-radius:8px;overflow:hidden;margin:8px 0 12px}

  /* Hero (Text) */
  .hero{position:relative;display:block;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08);text-decoration:none;color:inherit;margin-bottom:16px;background:#111}
  .hero .inner{padding:18px;color:#fff}
  .hero h2{margin:6px 0 0;font-size:26px}
  .hero p{margin:8px 0 0;color:#f3f3f3}
  .meta{font-size:12px;color:#666}
  .badge{font-size:10px;font-weight:800;letter-spacing:.3px;padding:2px 6px;border-radius:999px}
  .beta{background:#ffe58a;color:#111}

  /* LIVE-Badge auf dem Hero */
  .live-badge{
    position:absolute;top:10px;left:10px;z-index:2;
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.45);
    color:#fff;font-weight:800;font-size:12px;letter-spacing:.3px
  }
  .live-dot{width:10px;height:10px;border-radius:50%;background:var(--red);opacity:.25;animation:liveblink .9s ease-in-out infinite alternate}
  @keyframes liveblink{from{opacity:.25}to{opacity:1}}

  /* Grid (Text-Karten) */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  .card{display:block;background:#fff;border-radius:12px;overflow:hidden;text-decoration:none;color:inherit;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .card .inner{padding:12px}
  .card h3{margin:4px 0 0;font-size:16px;line-height:1.25}
  .card p{margin:8px 0 0;color:#444;font-size:14px}

  /* Article page */
  .article{max-width:860px;margin:18px auto;padding:0 16px;position:relative}
  .article h1{font-size:24px;margin:8px 0}

  /* Meta-Zeile im Artikel */
  .article .meta-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:6px 0 10px}
  .meta-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .meta-actions{margin-left:auto;position:relative;display:flex;align-items:center}

  .article .sources{margin-top:18px;padding:12px;background:#f7f7f7;border-radius:8px}
  .article .sources a{color:#e50914}
  .article-body p{margin:12px 0;line-height:1.6}
  .article-body ul{margin:10px 0 0 0;padding-left:0;list-style-position:inside}
  .article-body li{margin:6px 0;line-height:1.5}
  .back{display:inline-block;margin:12px 16px;color:#e50914;text-decoration:none;font-weight:700;cursor:pointer}
  footer{padding:18px;text-align:center;color:#666}

  /* Modal Personalisieren */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;border-radius:12px;max-width:560px;width:92%;box-shadow:0 25px 80px rgba(0,0,0,.25);overflow:hidden}
  .modal header{background:#f8f8f8;color:#111;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
  .modal header h3{margin:0;font-size:18px}
  .modal .content{padding:14px 16px;max-height:60vh;overflow:auto}
  .modal .cats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .modal .cat{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #eee;border-radius:10px}
  .modal footer{padding:12px 16px;display:flex;gap:8px;border-top:1px solid #eee;background:#fafafa}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:#e50914;color:#fff;border-color:#e50914}
  .btn.ghost{background:transparent;border-color:transparent;color:#555}
  .note{font-size:12px;color:#666}
  .fade{animation:fade .25s ease-in}
  @keyframes fade{from{opacity:.5}to{opacity:1}}

  /* Text-Filter-Button */
  .filter-btn{
    display:inline-flex;align-items:center;gap:8px;
    border:1px solid #e6e6e6;background:linear-gradient(180deg,#ffffff,#f6f6f6);
    border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.06);letter-spacing:.2px;color:var(--red)
  }
  .filter-btn .chev{display:inline-block;transition:transform .18s ease}
  .filter-btn[aria-expanded="true"] .chev{transform:rotate(180deg)}
  .filter-caption{font-size:12px;color:#666;margin-left:2px}

  /* CSS Filter-Icon */
  .ficon{display:inline-block;width:18px;height:14px;position:relative}
  .ficon em{position:absolute;left:50%;transform:translateX(-50%);height:4px;background:var(--red);border-radius:2px}
  .ficon em:nth-child(1){top:0;width:18px}
  .ficon em:nth-child(2){top:5px;width:12px}
  .ficon em:nth-child(3){top:10px;width:7px}

  /* Dropdown */
  .filter-menu{
    position:absolute;right:0;top:calc(100% + 8px);z-index:5;background:#fff;border:1px solid #ececec;border-radius:12px;
    box-shadow:0 18px 40px rgba(0,0,0,.12);min-width:220px;display:none;overflow:hidden
  }
  .filter-menu.open{display:block}
  .filter-item{width:100%;text-align:left;border:0;background:#fff;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px}
  .filter-item:hover{background:#f9f9f9}
  .filter-item .dot{width:10px;height:10px;border-radius:999px;background:#d0d0d0}
  .filter-item.active .dot{background:var(--red)}

  /* Teilen */
  .share-section{margin-top:14px}
  .share-section h3{margin:0 0 8px 0}
  .share-buttons{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .sbtn{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
        box-shadow:0 6px 18px rgba(0,0,0,.08);border:1px solid rgba(255,255,255,.3);cursor:pointer}
  .sbtn.sys{background:linear-gradient(180deg,#ffffff,#f6f6f6)}
  .sbtn.mail{background:linear-gradient(180deg,#ffffff,#f6f6f6)}
  .sbtn.insta{border-radius:50%;background:conic-gradient(from 200deg,#f58529,#dd2a7b,#8134af,#515bd4,#f58529)}
  .sbtn.x{border-radius:50%;background:#000;color:#fff;font-weight:900}
  .sbtn.fb{border-radius:50%;background:#3b5998;color:#fff}
  .sbtn.tiktok{border-radius:50%;background:#000;color:#fff;position:relative}
  .sbtn .glyph{font-weight:900}
  .sbtn svg{width:20px;height:20px;display:block}
  .sbtn.tiktok .dual{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;
                     filter:drop-shadow(1px 1px 0 #f52d55) drop-shadow(-1px -1px 0 #00f7e9)}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;
         padding:8px 12px;border-radius:999px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.18);opacity:0;pointer-events:none;transition:opacity .18s}
  .toast.show{opacity:1}
</style>
</head>
<body>

<header>
  <h1><a class="brand" id="brandLink" href="#/">AI <em>NEWS</em></a></h1>
</header>

<nav id="nav"></nav>

<main id="app">
  <div id="loading">Lade…</div>
</main>

<footer>© AI NEWS</footer>

<!-- Personalisieren Modal -->
<div id="personalizeBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="persoTitle">
    <header>
      <h3 id="persoTitle">Kategorien personalisieren</h3>
      <button id="btnCloseModal" class="btn ghost" aria-label="Schließen">✕</button>
    </header>
    <div class="content">
      <p>Wähle aus, welche Kategorien in der Leiste angezeigt werden sollen.</p>
      <div id="catsList" class="cats"></div>
      <p class="note">Hinweis: Mindestens eine Kategorie muss aktiviert bleiben.</p>
    </div>
    <footer>
      <button id="btnSelectAll" class="btn">Alle auswählen</button>
      <button id="btnSelectDefault" class="btn">Standard</button>
      <button id="btnReset" class="btn">Zurücksetzen</button>
      <div style="flex:1"></div>
      <button id="btnCancel" class="btn">Abbrechen</button>
      <button id="btnSave" class="btn primary">Speichern</button>
    </footer>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">Link kopiert</div>

<script>
/* ========= Flags ========= */
const DEMO_ONLY = true;
const MIN_ARTICLES = 10;
const DEMO_IMAGE = (id,w,h)=>`https://picsum.photos/seed/${encodeURIComponent(id)}/${w}/${h}`;

/* ========= Kategorien & Routing ========= */
const ALL_CATS = [
  {slug:"",           label:"Nachrichten",  cat:"Top"},
  {slug:"politik",    label:"Politik",      cat:"Politik"},
  {slug:"finanzen",   label:"Finanzen",     cat:"Finanzen"},
  {slug:"sport",      label:"Sport",        cat:"Sport"},
  {slug:"fussball",   label:"Fußball",      cat:"Fußball"},
  {slug:"kultur",     label:"Kultur",       cat:"Kultur"},
  {slug:"entertainment", label:"Entertainment", cat:"Entertainment"},
  {slug:"wissenschaft",  label:"Wissenschaft",  cat:"Wissenschaft"}
];
const SLUG_TO_CAT = Object.fromEntries(ALL_CATS.map(c=>[c.slug||"", c.cat]));
const CAT_TO_SLUG = Object.fromEntries(ALL_CATS.map(c=>[c.cat, c.slug||""]));
const DEFAULT_VISIBLE = ALL_CATS.map(c=>c.slug||"");

const LS_VISIBLE_KEY = "AIN_visible_slugs_v2";
const LS_LAST_SLUG   = "AIN_last_slug_v2";
const LS_TEXT_MODE   = "AIN_text_mode_v2";
let TEXT_MODE = localStorage.getItem(LS_TEXT_MODE) || 'long';
if (TEXT_MODE === 'short') TEXT_MODE = 'medium';
function saveTextMode(mode){ TEXT_MODE = mode; localStorage.setItem(LS_TEXT_MODE, mode); }

function loadVisibleSlugs(){
  try{
    const raw = localStorage.getItem(LS_VISIBLE_KEY);
    const arr = raw ? JSON.parse(raw) : null;
    if (Array.isArray(arr) && arr.length) return arr;
  }catch{}
  return [...DEFAULT_VISIBLE];
}
function saveVisibleSlugs(slugs){ localStorage.setItem(LS_VISIBLE_KEY, JSON.stringify(slugs)); }
function getVisibleCats(){ const vis=loadVisibleSlugs(); return ALL_CATS.filter(c=>vis.includes(c.slug||"")); }

let LAST_SLUG = localStorage.getItem(LS_LAST_SLUG) || "";

/* ========= Nav ========= */
const navEl = document.getElementById('nav');
function renderNav(activeSlug){
  navEl.innerHTML = "";

  const visible = getVisibleCats();
  const slugsOnly = visible.map(v=>v.slug||"");
  if (activeSlug != null && slugsOnly.length){
    const ok = slugsOnly.includes(activeSlug);
    if (!ok){
      const target = slugsOnly[0];
      location.hash = target ? `#/${target}` : "#/";
      activeSlug = target;
    }
  }

  const tabs = document.createElement('div');
  tabs.className = 'tabs-wrap';
  visible.forEach(v=>{
    const href = v.slug ? `#/${v.slug}` : "#/";
    const a = document.createElement('a');
    a.className = "tab";
    a.href = href;
    a.textContent = v.label;
    const isRoot = href==="#/";
    const match = isRoot ? (!activeSlug || activeSlug==="/" || activeSlug==="") : (v.slug===activeSlug);
    if (match) a.classList.add('active');
    tabs.appendChild(a);
  });
  navEl.appendChild(tabs);

  const search = document.createElement('input');
  search.type = 'search';
  search.className = 'nav-search';
  search.placeholder = 'Suchen …';
  search.disabled = true;
  search.setAttribute('aria-disabled','true');
  navEl.appendChild(search);

  const btn = document.createElement('button');
  btn.id = "btnPersonalize";
  btn.className = "personalize";
  btn.type = "button";
  btn.textContent = "+ Personalisieren";
  btn.addEventListener('click', openPersonalize);
  navEl.appendChild(btn);
}
function setActiveTab(slug){ renderNav(slug); }

/* ========= Store ========= */
const STORE={byId:{},mode:"demo"};

/* ========= Demo-/BETA-Daten ========= */
function demoNowMinus(min){ return new Date(Date.now()-min*60000).toISOString(); }
function mkLongDemoBody(title, dek){
  const base = (dek||"") + " " + (title||"");
  const filler = [
    "Analysten bewerten die aktuelle Entwicklung differenziert und verweisen auf vergleichbare Fälle der vergangenen Jahre.",
    "Im Mittelpunkt steht die Frage, wie sich die Beschlüsse kurzfristig auf Wirtschaft, Gesellschaft und Verwaltung auswirken.",
    "Behörden betonen, dass weitere Details in den kommenden Tagen folgen sollen, sobald Abstimmungen abgeschlossen sind.",
    "Branchenvertreter erwarten eine Mischung aus Chancen und Herausforderungen, insbesondere bei Umsetzung und Finanzierung.",
    "Aus Expertensicht sind Datenqualität, Transparenz und klare Zuständigkeiten entscheidend für den Erfolg.",
    "Mehrere Stakeholder fordern, Betroffene frühzeitig einzubinden und Feedbackschleifen verbindlich zu machen.",
    "Langfristig könnte die Maßnahme als Blaupause für ähnliche Projekte in anderen Regionen dienen."
  ];
  const sentences = (base + ". " + filler.join(". ") + ".").split(". ").map(s=>s.trim()).filter(Boolean);
  const paras = [];
  let buf=[], len=0;
  for(const s of sentences){
    const add = (buf.length? " " : "") + s + ".";
    if(len + add.length > 2200 && paras.length>=5) break;
    buf.push(s + ".");
    len += add.length;
    if(buf.length>=3){ paras.push(buf.join(" ")); buf=[]; }
  }
  if(buf.length) paras.push(buf.join(" "));
  return paras.slice(0,7);
}
function mkDemo(cat,title,dek,mins,srcCount=1){
  const id = "demo-"+Math.random().toString(36).slice(2,8);
  const sources = Array.from({length:srcCount},(_,i)=>({
    source:`Demo Newswire ${i+1}`,
    title:`${title} – Quelle ${i+1}`,
    url:`https://example.com/demo/${i+1}`
  }));
  return {
    id, title, dek,
    pub: demoNowMinus(mins),
    firstPub: demoNowMinus(mins+5),
    sources, sourceCount: sources.length,
    cat,
    image: DEMO_IMAGE(id, 1200, 630),
    imageCard: DEMO_IMAGE(id+"c", 800, 420),
    imageHero: DEMO_IMAGE(id+"h", 1200, 580),
    bodyParas: mkLongDemoBody(title, dek)
  };
}
function demoList(cat){
  const base = {
    Top: [
      ["Demo: Regierung kündigt Digitalpakt an","Neuer Digitalpakt mit Fokus auf Infrastruktur, Bildung und Verwaltung.",5,3],
      ["Demo: Energiepreise sinken deutlicher","Branchenverband erwartet stabile Entwicklung im Frühling.",16,2],
      ["Demo: Bahn plant zusätzliche Fernzüge","Mehr Kapazität an Reisetagen, Fokus auf internationale Verbindungen.",27,1],
      ["Demo: Bund startet Förderprogramm KI","Schwerpunkt Mittelstand und Forschung.",33,2],
      ["Demo: Neue Cyberstrategie vorgestellt","Mehr Resilienz kritischer Infrastrukturen.",41,1],
      ["Demo: Wohnbaupaket beschlossen","Ziel: schnellere Genehmigungen und Neubau.",55,2],
      ["Demo: Zoll stellt Rekord bei Kontrollen auf","Mehr Aufdeckungen in Logistikzentren.",63,1],
      ["Demo: Nationale Plattform für eID","Pilotierung startet in Großstädten.",71,2],
      ["Demo: Gesundheitsreform im Kabinett","Digitale Akten verpflichtend bis 2027.",84,1],
      ["Demo: Schulen erhalten Digitalcoaches","Ausbau von Medienkompetenz.",95,1],
      ["Demo: Gründerfonds erweitert","Startups erhalten leichter Kapitalzugang.",108,2],
      ["Demo: Breitband-Ausbau erreicht Meilenstein","95% Abdeckung im 5G-Netz.",117,2]
    ],
    Politik: [
      ["Demo: Parlament debattiert Haushaltsentwurf","Opposition fordert Nachbesserungen, Ausschuss berät Investitionen.",9,2],
      ["Demo: Außenminister reist zu Gipfel","Gespräche zu Sicherheits- und Handelsthemen angekündigt.",30,1],
      ["Demo: Koalitionsausschuss vertagt","Komplexe Dossiers in Arbeitsgruppen.",44,1],
      ["Demo: Länder fordern mehr Mittel","Föderale Programme sollen verstetigt werden.",52,2],
      ["Demo: Untersuchungsausschuss befragt Zeugen","Schwerpunkte Datenschutz und Vergabe.",63,1],
      ["Demo: Verfassungsgericht verhandelt Klage","Streit um Kompetenzen.",75,1],
      ["Demo: Wahlrechtsreform passiert erste Hürde","Sperrklauseln in der Diskussion.",82,2],
      ["Demo: Parlamentspräsident mahnt Einigkeit an","Appell für übergreifende Lösungen.",91,1],
      ["Demo: Referendum über Verwaltungsreform","Beteiligung über digitale Kanäle.",103,1],
      ["Demo: Fraktionen einigen sich auf Zeitplan","Plenarwochen fixiert.",115,1],
      ["Demo: Vermittlungsausschuss angesetzt","Suche nach Kompromisslinien.",127,1],
      ["Demo: EU-Rat tagt zu Binnenmarkt","Grenzübergreifende Dienste im Fokus.",141,2]
    ],
    Finanzen: [
      ["Demo: Inflation fällt stärker als erwartet","Ökonomen sehen Spielraum für Zinssenkungen, Märkte reagieren positiv.",7,3],
      ["Demo: Tech-Konzern übertrifft Prognosen","Umsatz im Cloud-Geschäft wächst, Aktie legt zu.",24,1],
      ["Demo: DAX nähert sich Rekordhoch","Industriewerte im Plus.",31,2],
      ["Demo: EZB signalisiert Kurs halten","Zinsgipfel abgewartet.",46,1],
      ["Demo: IPO belebt Primärmarkt","Überzeichnung binnen Stunden.",55,2],
      ["Demo: Startup sammelt Serie-B","Skalierung in EU geplant.",64,1],
      ["Demo: Bankenverband warnt vor Risikomodellen","Stresstests ausgeweitet.",73,1],
      ["Demo: Rohölpreis sinkt","Terminkurven drehen in Contango.",88,2],
      ["Demo: Private Equity kauft Mittelständler","Digitalisierungsoffensive angekündigt.",97,1],
      ["Demo: Anleihemärkte stabil","Spread-Kompression in Peripherie.",106,1],
      ["Demo: Kryptomarkt volatil","Altcoins im Fokus.",118,1],
      ["Demo: Devisenmarkt ruhig","Carry-Trades profitieren.",129,1]
    ],
    Sport: [
      ["Demo: Nationalteam erreicht Finale","Spannendes Spiel mit spätem Tor – Trainer lobt Moral.",8,2],
      ["Demo: Überraschung im Basketball","Underdog gewinnt auswärts – Serie bleibt offen.",31,1],
      ["Demo: Marathon mit neuem Streckenrekord","Pace-Strategie geht auf.",45,1],
      ["Demo: Tennis: Favoritin im Halbfinale","Aufschlagquote überzeugt.",57,1],
      ["Demo: Radsport: Bergetappe entschieden","Attacke am letzten Anstieg.",66,1],
      ["Demo: Handball: Keeper überragt","Siebenmeterquote stark.",74,1],
      ["Demo: Eishockey: Shutout im Derby","Defensive steht sicher.",86,1],
      ["Demo: Leichtathletik: U20 mit Medaillen","Nachwuchs überzeugt.",99,1],
      ["Demo: Schwimmen: Nationalrekord über 200m","Negative-Split-Taktik.",112,1],
      ["Demo: Volleyball: Comeback nach 0:2","Blockarbeit zahlt sich aus.",124,1],
      ["Demo: Tischtennis: Sieg im Entscheidungsdurchgang","Platzierungsrunde offen.",135,1],
      ["Demo: Wintersport: Trainingslager eröffnet","Materialtests im Fokus.",146,1]
    ],
    Fußball: [
      ["Demo: Toptransfer kurz vor Abschluss","Verein bestätigt fortgeschrittene Gespräche, Medizincheck steht an.",6,2],
      ["Demo: Trainer verlängert Vertrag","Langfristige Planung soll Talente fördern.",29,1],
      ["Demo: UCL-Auslosung bringt Kracher","Faninteresse riesig.",41,1],
      ["Demo: Abwehrchef kehrt ins Training zurück","Reha verläuft planmäßig.",52,1],
      ["Demo: Talentsichtung in Akademie","Scouting erweitert Netzwerk.",63,1],
      ["Demo: Ticketrekord beim Heimspiel","Vereinsinterne Bestmarke.",71,1],
      ["Demo: VAR-Debatte flammt auf","Verbände kündigen Austausch an.",83,1],
      ["Demo: Neuer Trikotsponsor vorgestellt","Mehr Engagement im Jugendbereich.",95,1],
      ["Demo: Pokal-Halbfinale terminiert","Sicherheitskonzept abgestimmt.",106,1],
      ["Demo: Spielplanverdichtung kritisiert","Belastungssteuerung im Gespräch.",118,1],
      ["Demo: Jugendteam gewinnt Turnier","Durchmarsch ohne Gegentor.",129,1],
      ["Demo: Stadionmodernisierung genehmigt","Kapazitätserhöhung geplant.",141,1]
    ],
    Kultur: [
      ["Demo: Neues Museum eröffnet","Interaktive Formate – Besucherandrang zur Eröffnung.",11,1],
      ["Demo: Festivalprogramm steht","Kuratorisches Thema: Wandel.",22,1],
      ["Demo: Opernpremiere gefeiert","Standing Ovations zum Finale.",34,1],
      ["Demo: Theater erhält Preis","Experimentelle Bühne geehrt.",47,1],
      ["Demo: Literaturpreis vergeben","Debüt überzeugt Jury.",58,1],
      ["Demo: Ausstellung verlängert","Besucherzahlen über Erwartungen.",69,1],
      ["Demo: Restaurierung abgeschlossen","Ikonisches Werk kehrt zurück.",81,1],
      ["Demo: Filmarchiv digitalisiert Bestände","Zugang für Forschung erleichtert.",95,1],
      ["Demo: Philharmonie kündigt Tournee an","Neue Programme geplant.",107,1],
      ["Demo: Designbiennale mit Rekord","Internationale Beteiligung wächst.",119,1],
      ["Demo: Jazzfestival startet","Open-Air-Konzerte angekündigt.",131,1],
      ["Demo: Stadt richtet Kulturfonds ein","Förderlinien angepasst.",142,1]
    ],
    Entertainment: [
      ["Demo: Blockbuster startet stark","Premierenwochenende übertrifft Erwartungen – Kritiken gemischt.",14,2],
      ["Demo: Serie verlängert um Staffel","Showrunner bestätigt Drehstart.",26,1],
      ["Demo: Musikpreis-Nominierungen veröffentlicht","Vielfältiges Feld.",38,1],
      ["Demo: Streamingdienst mit Rekordabo","Neues Abo-Modell zieht.",51,1],
      ["Demo: Regisseur kündigt Sci-Fi an","Dreharbeiten im Herbst.",63,1],
      ["Demo: Biopic feiert Premiere","Standing Ovations in Cannes.",75,1],
      ["Demo: Spielverfilmung bestätigt","Drehbuchautor engagiert.",88,1],
      ["Demo: Chartstürmer erreicht Platin","Kollaboration schlägt ein.",99,1],
      ["Demo: Award-Show bekommt neuen Host","Publikum reagiert positiv.",110,1],
      ["Demo: Animationsstudio mit Kurzfilmreihe","Künstlerische Experimente.",121,1],
      ["Demo: Comedy-Special angekündigt","Tourdaten folgen.",132,1],
      ["Demo: Festival setzt auf Nachhaltigkeit","Green-Stages geplant.",143,1]
    ],
    Wissenschaft: [
      ["Demo: Durchbruch bei Batterien","Neue Kathodenstruktur erhöht Zyklenzahl – Pilotprojekt angekündigt.",10,2],
      ["Demo: Teleskop entdeckt Exoplaneten","Daten bestätigen Transit.",22,1],
      ["Demo: mRNA-Plattform erweitert","Anwendung in Onkologie.",34,1],
      ["Demo: Quantenchip stabiler","Fehlerraten sinken signifikant.",46,1],
      ["Demo: Klima-Studie zu Extremwetter","Attributionsforschung präziser.",58,1],
      ["Demo: Fusionsforschung erzielt Rekord","Energieertrag verbessert.",70,1],
      ["Demo: CRISPR-Variante präziser","Off-Target-Effekte reduziert.",81,1],
      ["Demo: Meeresspiegel-Analyse aktualisiert","Satellitendaten verdichten Trends.",93,1],
      ["Demo: Material entdeckt mit Supraleitung","Niedrige Druckbedingungen ausreichend.",104,1],
      ["Demo: Robotik in der Pflege erprobt","Assistenzsysteme im Einsatz.",116,1],
      ["Demo: Mathematikpreis vergeben","Neue Beweise für alte Vermutungen.",128,1],
      ["Demo: Raumfahrt: Sonde erreicht Zielorbit","Erste Messreihen starten.",139,1]
    ]
  }[cat] || [];
  return base.map(([t,d,m,s])=>mkDemo(cat,t,d,m,s));
}
const DEMO = {
  Top: demoList("Top"),
  Politik: demoList("Politik"),
  Finanzen: demoList("Finanzen"),
  Sport: demoList("Sport"),
  Fußball: demoList("Fußball"),
  Kultur: demoList("Kultur"),
  Entertainment: demoList("Entertainment"),
  Wissenschaft: demoList("Wissenschaft")
};

/* ========= Helpers ========= */
function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  try{
    return new Intl.DateTimeFormat('de-DE',{weekday:'short', day:'2-digit', month:'2-digit', year:'numeric',hour:'2-digit', minute:'2-digit'}).format(d);
  }catch{ return d.toLocaleString('de-DE'); }
}
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function trunc(s,n){ s=s||''; return s.length>n ? s.slice(0,n-1)+'…' : s; }
function showToast(text="Link kopiert"){
  const t=document.getElementById('toast'); if(!t) return;
  t.textContent = text;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1100);
}

/* ========= Rendering-Helfer ========= */
function makeHero(a){
  const media = a.imageHero ? `<div class="media"><img loading="lazy" src="${a.imageHero}" alt="${escapeHtml(a.title)}"></div>` : "";
  return `
  <a class="hero fade" href="#/artikel/${a.id}">
    ${media}
    <div class="live-badge" aria-hidden="true"><span class="live-dot"></span><span>LIVE</span></div>
    <div class="inner">
      <div class="meta" style="color:#bbb">
        <span>${fmtDate(a.firstPub || a.pub)} • Aggregiert aus ${a.sourceCount|| (a.sources?.length||1)} Quelle${(a.sourceCount|| (a.sources?.length||1))>1?'n':''}</span>
        <span class="badge beta">BETA</span>
      </div>
      <h2>${escapeHtml(a.title)}</h2>
      <p>${escapeHtml(trunc(a.dek,220))}</p>
    </div>
  </a>`;
}
function makeCard(a){
  const media = a.imageCard ? `<div class="media"><img loading="lazy" src="${a.imageCard}" alt="${escapeHtml(a.title)}"></div>` : "";
  return `
  <a class="card fade" href="#/artikel/${a.id}">
    ${media}
    <div class="inner">
      <div class="meta">
        <span>${fmtDate(a.firstPub || a.pub)} • Aggregiert aus ${a.sourceCount|| (a.sources?.length||1)} Quelle${(a.sourceCount|| (a.sources?.length||1))>1?'n':''}</span>
        <span class="badge beta">BETA</span>
      </div>
      <h3>${escapeHtml(a.title)}</h3>
      <p>${escapeHtml(trunc(a.dek,180))}</p>
    </div>
  </a>`;
}

/* ========= Zusammenfassung (mittel) ========= */
const STOP_DE = new Set(("der,die,das,und,oder,aber,im,in,an,am,auf,aus,mit,für,ohne,um,zu,beim,vom,von,dem,den,des,ein,eine,einer,einem,eines,ist,sind,war,waren,wird,werden,hat,haben,wurde,auch,nicht,noch,schon,so,wie,als,mehr,weniger,über,unter,zwischen,gegen,nach,vor,seit,bis,bei,man,es,wir,ihr,er,sie,ihn,ihm,uns,eu,ihrer,deren,am,beide,alle,jede,kein,keine,keinen").split(","));
function tokens(s){
  return (s||"").toLowerCase()
    .replace(/[^a-z0-9äöüß ]/gi," ")
    .split(/\s+/).filter(t=>t && t.length>2 && !STOP_DE.has(t));
}
function jaccardWords(a,b){
  const A=new Set(tokens(a)), B=new Set(tokens(b));
  const inter=[...A].filter(x=>B.has(x)).length;
  const uni=new Set([...A,...B]).size||1;
  return inter/uni;
}
function splitSentences(paras){
  const text = (paras||[]).join(" ").replace(/\s+/g," ").trim();
  if(!text) return [];
  return text.split(/(?<=[.!?])\s+/).map(s=>s.trim()).filter(Boolean);
}
function scoreSentence(s, idx, total){
  const len = s.length, target=140;
  const lengthScore = Math.max(0, 1 - Math.abs(len-target)/target);
  const positionScore = 1 - (idx/(total||1))*0.5;
  const digitScore = /\d/.test(s) ? 0.12 : 0;
  const dashScore = /[:–\-]/.test(s) ? 0.06 : 0;
  return lengthScore*0.6 + positionScore*0.22 + digitScore + dashScore;
}
function summarizeMedium(paras, targetChars=900, maxSentences=8, simThreshold=0.6){
  const sents = splitSentences(paras);
  const scored = sents.map((s,i)=>({s, i, sc: scoreSentence(s,i,sents.length)})).sort((a,b)=>b.sc-a.sc);
  const chosen=[];
  let totalLen=0;
  for(const cand of scored){
    const redundant = chosen.some(x=>jaccardWords(x.s, cand.s) >= simThreshold);
    if(redundant) continue;
    if(totalLen + cand.s.length + 1 > targetChars && chosen.length>=3) continue;
    chosen.push(cand);
    totalLen += cand.s.length + 1;
    if(chosen.length>=maxSentences) break;
  }
  chosen.sort((a,b)=>a.i-b.i);
  const perPara = Math.max(3, Math.ceil(chosen.length/2));
  const out=[];
  for(let i=0;i<chosen.length;i+=perPara){
    out.push(chosen.slice(i,i+perPara).map(x=>x.s).join(" "));
  }
  return out;
}

/* ========= Text-Ansicht (Filter) ========= */
function renderArticleBodyHTML(a, mode){
  const paras = a.bodyParas && a.bodyParas.length ? a.bodyParas : [a.dek||""];
  if(mode === 'medium'){
    const mids = summarizeMedium(paras, 900, 8, 0.6);
    const effective = mids.length ? mids : [paras[0]||""];
    return `<div class="article-body">${effective.map(p=>`<p>${escapeHtml(p)}</p>`).join("")}</div>`;
  }
  if(mode === 'points'){
    const ptsFull = splitSentences(paras);
    const picked=[]; 
    for(const s of ptsFull){
      let dup=false;
      for(const p of picked){ if(jaccardWords(p,s)>0.6){ dup=true; break; } }
      if(!dup) picked.push(s);
      if(picked.length>=7) break;
    }
    return `<div class="article-body"><ul>${picked.map(p=>`<li>${escapeHtml(p)}</li>`).join("")}</ul></div>`;
  }
  return `<div class="article-body">${paras.map(p=>`<p>${escapeHtml(p)}</p>`).join("")}</div>`;
}
function buildFilterMenu(current){
  return `
    <div class="filter-menu" id="filterMenu" role="menu" aria-hidden="true">
      <button class="filter-item ${current==='long'?'active':''}" data-mode="long" role="menuitem">
        <span class="dot"></span><span>Lang (Standard)</span>
      </button>
      <button class="filter-item ${current==='medium'?'active':''}" data-mode="medium" role="menuitem">
        <span class="dot"></span><span>Mittel (gekürzt)</span>
      </button>
      <button class="filter-item ${current==='points'?'active':''}" data-mode="points" role="menuitem">
        <span class="dot"></span><span>Keypoints</span>
      </button>
    </div>`;
}

/* ========= Teilen ========= */
function buildShareSection(a){
  const src = (a.sources && a.sources[0] && a.sources[0].url) ? a.sources[0].url : (location.origin + location.pathname + location.hash);
  const title = a.title || "AI NEWS";
  return `
    <div class="share-section">
      <h3>Teilen</h3>
      <div class="share-buttons">
        <button id="btnShareSys" class="sbtn sys" title="Teilen">
          <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" />
            <path d="M12 3v14" />
            <path d="M7 8l5-5 5 5" />
          </svg>
        </button>
        <a id="btnShareMail" class="sbtn mail" title="Mail" href="mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(src)}">
          <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 4h16v16H4z" />
            <path d="M22 6l-10 7L2 6" />
          </svg>
        </a>
        <button id="btnShareIG" class="sbtn insta" title="Instagram">
          <svg viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M8 7h8a1 1 0 011 1v8a1 1 0 01-1 1H8a1 1 0 01-1-1V8a1 1 0 011-1zm7.5-2.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM12 9.5A2.5 2.5 0 109.5 12 2.5 2.5 0 0012 9.5z"/></svg>
        </button>
        <a id="btnShareX" class="sbtn x" title="X" target="_blank" rel="noopener"
           href="https://x.com/intent/tweet?text=${encodeURIComponent(title+' – '+src)}"><span class="glyph">X</span></a>
        <a id="btnShareFB" class="sbtn fb" title="Facebook" target="_blank" rel="noopener"
           href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(src)}"><span class="glyph">f</span></a>
        <button id="btnShareTT" class="sbtn tiktok" title="TikTok"><span class="dual">♪</span><span style="opacity:0">♪</span></button>
        <button id="btnCopyLink" class="sbtn sys" title="Link kopieren">
          <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M10 13a5 5 0 007.07 0l2.83-2.83a5 5 0 00-7.07-7.07L11 4" />
            <path d="M14 11a5 5 0 00-7.07 0L4.1 13.83a5 5 0 007.07 7.07L13 20" />
          </svg>
        </button>
      </div>
    </div>
  `;
}
function attachShareHandlers(a){
  const shareUrl = (a.sources && a.sources[0] && a.sources[0].url) ? a.sources[0].url : (location.origin + location.pathname + location.hash);
  const shareText = `${a.title} – ${shareUrl}`;

  const sys = document.getElementById('btnShareSys');
  if (sys){
    sys.addEventListener('click', async ()=>{
      if (navigator.share){
        try{ await navigator.share({title:a.title, text:a.title, url:shareUrl}); }catch{}
      } else {
        try{ await navigator.clipboard.writeText(shareText); showToast(); }catch{}
      }
    });
  }
  const ig = document.getElementById('btnShareIG');
  if (ig){
    ig.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(shareText); showToast(); }catch{}
    });
  }
  const tt = document.getElementById('btnShareTT');
  if (tt){
    tt.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(shareText); showToast(); }catch{}
    });
  }
  const copy = document.getElementById('btnCopyLink');
  if (copy){
    copy.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(shareUrl); showToast(); }catch{}
    });
  }
}

/* ========= Rendering Liste/Artikel ========= */
let renderCountInitial = 12, renderStep = 12;

function renderList(cat, arts){
  const app=document.getElementById('app');
  if(!arts||!arts.length){ app.innerHTML=`<p style="padding:16px;color:#666">Keine Artikel gefunden.</p>`; return; }

  if (arts.length < MIN_ARTICLES){
    const padded = arts.slice();
    while (padded.length < MIN_ARTICLES) padded.push(arts[padded.length % arts.length]);
    arts = padded;
  }
  STORE.byId=Object.fromEntries(arts.map(a=>[a.id,a]));

  const top=arts[0];
  const hero = makeHero(top);

  const rest=arts.slice(1);
  const firstChunk=rest.slice(0,renderCountInitial-1).map(makeCard).join('');
  const moreLeft=rest.length-(renderCountInitial-1);

  app.innerHTML = `${hero}<div id="grid" class="grid">${firstChunk}</div>${moreLeft>0?`<button id="loadmore" class="btn">Mehr laden (${moreLeft})</button>`:''}`;

  const btn=document.getElementById('loadmore');
  if(btn){
    btn.addEventListener('click',()=>{
      const grid=document.getElementById('grid');
      const next=rest.slice(renderCountInitial-1,renderCountInitial-1+renderStep).map(makeCard).join('');
      grid.insertAdjacentHTML('beforeend',next);
      renderCountInitial+=renderStep;
      const remaining=rest.length-(renderCountInitial-1);
      if(remaining>0) btn.textContent=`Mehr laden (${remaining})`; else btn.remove();
    });
  }
}

async function renderCategory(cat,slug){
  LAST_SLUG=slug||""; localStorage.setItem(LS_LAST_SLUG, LAST_SLUG);
  setActiveTab(LAST_SLUG);
  const app=document.getElementById('app');
  app.innerHTML=`<div id="loading">Lade Artikel…</div>`;

  const demoListArr = (DEMO[cat] || DEMO.Top) ?? [];
  const arts = demoListArr.slice().sort((a,b)=>Date.parse(b.pub)-Date.parse(a.pub));
  renderList(cat, arts);
}

function attachBackHandler(){
  const link = document.getElementById('backLink');
  if(!link) return;
  link.addEventListener('click', handleBack);
}
function handleBack(e){
  e.preventDefault();
  const fallback = LAST_SLUG ? `#/${LAST_SLUG}` : "#/";
  const before = location.hash;
  let navigated = false;
  const onHash = ()=>{ navigated = true; window.removeEventListener('hashchange', onHash); };
  window.addEventListener('hashchange', onHash, {once:true});

  if (history.length > 1) history.back();
  setTimeout(()=>{ if(!navigated || location.hash === before){ location.hash = fallback; } }, 200);
}

function attachFilterHandlers(a){
  const btn = document.getElementById('filterBtn');
  const menu = document.getElementById('filterMenu');
  const bodyWrap = document.getElementById('articleBodyContainer');
  if(!btn || !menu || !bodyWrap) return;

  bodyWrap.innerHTML = renderArticleBodyHTML(a, TEXT_MODE);
  const label = document.getElementById('filterCaption');
  if (label) label.textContent = (TEXT_MODE==='long'?'Lang':TEXT_MODE==='medium'?'Mittel':'Keypoints');

  const closeMenu = ()=>{ menu.classList.remove('open'); menu.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); };
  const openMenu = ()=>{ menu.classList.add('open'); menu.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); };

  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(menu.classList.contains('open')) closeMenu(); else openMenu();
  });
  document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==btn) closeMenu(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

  menu.querySelectorAll('.filter-item').forEach(item=>{
    item.addEventListener('click', ()=>{
      const mode = item.getAttribute('data-mode');
      if(!mode) return;
      saveTextMode(mode);
      menu.querySelectorAll('.filter-item').forEach(i=>i.classList.remove('active'));
      item.classList.add('active');
      if (label) label.textContent = (mode==='long'?'Lang':mode==='medium'?'Mittel':'Keypoints');
      bodyWrap.innerHTML = renderArticleBodyHTML(a, TEXT_MODE);
      closeMenu();
    });
  });
}

async function renderArticle(id){
  setActiveTab(LAST_SLUG);
  const app=document.getElementById('app');
  app.innerHTML=`<div id="loading">Lade Artikel…</div>`;

  let a = STORE.byId[id];

  if(!a){
    let found=null, foundCat='Top';
    for (const [cat, arr] of Object.entries(DEMO)){
      found = (arr||[]).find(x=>x.id===id);
      if(found){ foundCat=cat; break; }
    }
    if(found){
      a = found;
      LAST_SLUG = CAT_TO_SLUG[foundCat] || "";
      localStorage.setItem(LS_LAST_SLUG, LAST_SLUG);
      STORE.byId[id] = a;
      setActiveTab(LAST_SLUG);
    }
  }

  if(!a){ app.innerHTML=`<p style="padding:16px;color:#666">Artikel nicht gefunden.</p>`; return; }

  const sources=(a.sources||[]).map(s=>`
    <li>${escapeHtml(s.source)}: <a href="${s.url}" target="_blank" rel="noopener">${escapeHtml(s.title)}</a></li>
  `).join('');
  const count = a.sourceCount || (a.sources?.length||1);

  const cover = a.image
    ? `<div class="media"><img loading="lazy" src="${a.image}" alt="${escapeHtml(a.title)}"></div>`
    : "";

  const metaRow = `
    <div class="meta-row">
      <div class="meta-left">
        <span class="meta">Veröffentlicht: ${fmtDate(a.firstPub || a.pub)} • Aggregiert aus ${count} Quelle${count>1?'n':''}</span>
        <span class="badge beta">BETA</span>
      </div>
      <div class="meta-actions">
        <button class="filter-btn" id="filterBtn" type="button" aria-haspopup="true" aria-expanded="false" title="Textansicht">
          <span class="ficon" aria-hidden="true"><em></em><em></em><em></em></span>
          <span>Text</span>
          <span class="filter-caption" id="filterCaption"> ${TEXT_MODE==='long'?'Lang':TEXT_MODE==='medium'?'Mittel':'Keypoints'}</span>
          <span class="chev">▾</span>
        </button>
        ${buildFilterMenu(TEXT_MODE)}
      </div>
    </div>
  `;

  app.innerHTML=`
    <a class="back" id="backLink" href="#/">← Zurück</a>
    <section class="article">
      ${metaRow}
      <h1>${escapeHtml(a.title)}</h1>
      ${cover}
      <div id="articleBodyContainer"></div>
      <div class="sources">
        <h3>Quellen</h3>
        <ul>${sources}</ul>
      </div>
      ${buildShareSection(a)}
    </section>`;
  attachBackHandler();
  attachFilterHandlers(a);
  attachShareHandlers(a);
}

/* ========= Router ========= */
function getRoute(){
  const hash=(location.hash||"#/").replace(/^#/,"");
  const parts=hash.split("/").filter(Boolean);
  if(!parts.length) return {name:"category",cat:"Top",slug:""};
  if(parts[0]==="artikel") return {name:"article",id:parts[1]||""};
  const slug=parts[0];
  return {name:"category",cat:SLUG_TO_CAT[slug]||"Top",slug};
}
async function route(){
  const r=getRoute();
  if (navEl.childElementCount===0) renderNav(r.name==="article" ? LAST_SLUG : (r.slug||""));
  if(r.name==="article") return renderArticle(r.id);
  return renderCategory(r.cat,r.slug);
}
window.addEventListener('hashchange',route);
renderNav(LAST_SLUG);
route();

/* ========= Personalisieren Modal ========= */
const backdrop = document.getElementById('personalizeBackdrop');
const catsList = document.getElementById('catsList');
const btnCloseModal = document.getElementById('btnCloseModal');
const btnCancel = document.getElementById('btnCancel');
const btnSave = document.getElementById('btnSave');
const btnSelectAll = document.getElementById('btnSelectAll');
const btnSelectDefault = document.getElementById('btnSelectDefault');
const btnReset = document.getElementById('btnReset');

function openPersonalize(){
  catsList.innerHTML = "";
  const selected = new Set(loadVisibleSlugs());
  ALL_CATS.forEach(c=>{
    const id = `ck_${c.slug||'root'}`;
    const wrap = document.createElement('label');
    wrap.className = "cat";
    wrap.innerHTML = `
      <input type="checkbox" id="${id}" ${selected.has(c.slug||"")?'checked':''} data-slug="${c.slug}">
      <span>${c.label}</span>
    `;
    catsList.appendChild(wrap);
  });
  backdrop.style.display = "flex";
  backdrop.setAttribute('aria-hidden','false');
}
function closePersonalize(){ backdrop.style.display = "none"; backdrop.setAttribute('aria-hidden','true'); }
function getModalSelection(){
  const boxes = catsList.querySelectorAll('input[type=checkbox]');
  const sel = [];
  boxes.forEach(b=>{ if(b.checked) sel.push(b.getAttribute('data-slug')||""); });
  return sel;
}
btnCloseModal.addEventListener('click', closePersonalize);
btnCancel.addEventListener('click', closePersonalize);
backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closePersonalize(); });

btnSelectAll.addEventListener('click', ()=>{ catsList.querySelectorAll('input[type=checkbox]').forEach(b=>b.checked=true); });
btnSelectDefault.addEventListener('click', ()=>{
  const def = new Set(DEFAULT_VISIBLE);
  catsList.querySelectorAll('input[type=checkbox]').forEach(b=>{
    const slug = b.getAttribute('data-slug')||"";
    b.checked = def.has(slug);
  });
});
btnReset.addEventListener('click', ()=>{
  localStorage.removeItem(LS_VISIBLE_KEY);
  const def = new Set(DEFAULT_VISIBLE);
  catsList.querySelectorAll('input[type=checkbox]').forEach(b=>{
    const slug = b.getAttribute('data-slug')||"";
    b.checked = def.has(slug);
  });
});
btnSave.addEventListener('click', ()=>{
  const sel = getModalSelection();
  if (!sel.length){ alert("Mindestens eine Kategorie muss aktiviert bleiben."); return; }
  saveVisibleSlugs(sel);
  const current = getRoute();
  const activeSlug = current.name==="article" ? LAST_SLUG : (current.slug||"");
  renderNav(activeSlug);
  if (!sel.includes(activeSlug)){
    const target = sel[0] || "";
    location.hash = target ? `#/${target}` : "#/";
  }
  closePersonalize();
});
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape' && backdrop.style.display === 'flex') closePersonalize();
});

/* --- Hotfix: Klick-Verhalten --- */
(function(){
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a.tab');
    if (!a) return;
    if (a.classList.contains('active')) {
      e.preventDefault();
      if (typeof route === 'function') route();
    }
  });
  const brand = document.getElementById('brandLink');
  if (brand) {
    brand.addEventListener('click', (e)=>{
      e.preventDefault();
      if (location.hash === '' || location.hash === '#' || location.hash === '#/') {
        if (typeof route === 'function') route();
      } else {
        location.hash = '#/';
      }
    });
  }
  window.addEventListener('hashchange', () => {
    const h = (location.hash||'').replace(/^#/,'');
    const parts = h.split('/').filter(Boolean);
    if (parts[0] === 'artikel' && typeof STORE !== 'undefined' && STORE && !STORE.byId[parts[1]]) {
      if (typeof getRoute === 'function' && typeof renderCategory === 'function') {
        const slug = (typeof LAST_SLUG !== 'undefined') ? LAST_SLUG : '';
        const catMap = (typeof SLUG_TO_CAT !== 'undefined') ? SLUG_TO_CAT : {};
        const cat = catMap[slug] || 'Top';
        renderCategory(cat, slug);
      }
    }
  });
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href^="#/artikel/"]');
    if (!a) return;
    const href = a.getAttribute('href') || '';
    if (href === (location.hash || '')) {
      e.preventDefault();
      if (typeof route === 'function') route();
    }
  });
})();
</script>
</body>
</html>
